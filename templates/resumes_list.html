{% extends "base.html" %}
{% block title %}My Resumes{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-10 text-white">

  <div class="flex items-center justify-between mb-6">
    <h1 class="text-3xl font-bold">My Resumes</h1>
    <a href="{{ url_for('upload_resume') }}"
       class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
      Upload / Generate
    </a>
  </div>

  {% if resumes %}
  <!-- Bulk delete form -->
  <form id="bulkDeleteForm" method="POST" action="{{ url_for('bulk_delete_resumes') }}"
        onsubmit="return confirm('Delete the selected resume(s)? This cannot be undone.');">

    <div class="flex items-center justify-between mb-4">
      <label class="inline-flex items-center gap-2">
        <input id="selectAll" type="checkbox" class="h-4 w-4 rounded border-gray-500">
        <span class="text-sm">Select all</span>
      </label>

      <button id="deleteSelectedBtn" type="submit"
              class="bg-red-600 hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed
                     text-white px-4 py-2 rounded"
              disabled>
        Delete selected
      </button>
    </div>

    <div class="divide-y divide-gray-700 rounded-lg border border-gray-700">
      {% for r in resumes %}
      <div class="flex items-center gap-4 p-4">
        <!-- selection -->
        <input type="checkbox" name="resume_ids" value="{{ r.id }}"
               class="resume-checkbox h-4 w-4 rounded border-gray-500">

        <!-- details -->
        <div class="flex-1">
          <div class="font-semibold">
            {{ r.original_name or ("Resume #" ~ r.id) }}
          </div>
          <div class="text-sm text-gray-400">
            {{ (r.type or '')|capitalize }}
            • {{ (r.created_at or r.timestamp)|default("", true) }}
            {% if r.template_name %} • Template: {{ r.template_name }}{% endif %}
          </div>
        </div>

        <!-- actions (no nested forms). Use `formaction` to call single delete. -->
        <div class="flex items-center gap-2">
          <a href="{{ url_for('view_resume_endpoint', id=r.id) }}"
             class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600">View</a>

          <button type="submit"
                  formmethod="post"
                  formaction="{{ url_for('delete_resume_endpoint', id=r.id) }}"
                  class="px-3 py-1 rounded bg-red-600 hover:bg-red-700"
                  onclick="return confirm('Delete this resume?');">
            Delete
          </button>
        </div>
      </div>
      {% endfor %}
    </div>
  </form>

  {% else %}
    <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
      <p class="text-gray-300 text-lg mb-6">No resumes found.</p>
      <div class="flex items-center justify-center gap-4">
        <a href="{{ url_for('upload_resume') }}"
           class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Upload Resume</a>
        <a href="{{ url_for('upload_resume') }}"
           class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded">Generate Resume</a>
      </div>
    </div>
  {% endif %}
</div>

<script>
  const selectAll = document.getElementById('selectAll');
  const deleteBtn  = document.getElementById('deleteSelectedBtn');
  const checkboxes = () => Array.from(document.querySelectorAll('.resume-checkbox'));

  function refreshDeleteState() {
    deleteBtn.disabled = !checkboxes().some(cb => cb.checked);
  }

  selectAll?.addEventListener('change', () => {
    checkboxes().forEach(cb => cb.checked = selectAll.checked);
    refreshDeleteState();
  });

  document.addEventListener('change', (e) => {
    if (e.target.classList?.contains('resume-checkbox')) {
      const all = checkboxes();
      selectAll.checked = all.length && all.every(c => c.checked);
      refreshDeleteState();
    }
  });

  refreshDeleteState();
</script>
{% endblock %}
